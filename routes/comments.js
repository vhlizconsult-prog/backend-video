import express from 'express'; import { query } from '../db.js'; import { authRequired } from './middleware.js'; export const commentsRouter = express.Router(); commentsRouter.get('/:videoId', async (req, res) => { const r = await query('SELECT c.*, u.email as user_email FROM comments c JOIN users u ON c.user_id=u.id WHERE video_id=$1 ORDER BY c.created_at ASC', [req.params.videoId]); res.json(r.rows.map(row => ({ id: row.id, body: row.body, createdAt: row.created_at, user: { id: row.user_id, email: row.user_email } }))); }); commentsRouter.post('/:videoId', authRequired, async (req, res) => { const { body } = req.body; if (!body) return res.status(400).json({ error: 'body required' }); const r = await query('INSERT INTO comments (body,video_id,user_id) VALUES ($1,$2,$3) RETURNING *', [body, req.params.videoId, req.user.id]); res.json(r.rows[0]); });